<!DOCTYPE html>
<!-- Le but est de tracer la source des sommes versées sur une PU
  * Le premier compte est forcément le compte courant payeur
  * En cascade doivent etre identifiées les sources si les fonds sont arrivés sur un support il y a moins de 6 mois pour les supports devant justifier leur origine
  * et la liste de documents à fournir par support est affichée
	* A terme cette liste pourrait etre différente en fonction des assureurs
	* le radio bouton partner permet de choisir le partner dans la structure contenant les données (sourceOptions). Le libellé doit etre identique à ce qui est fournit dans la structure Json
  * A noter la liste des banques n'est que suggérée il est possible de modifier le champ pour l'utilisateur
 --> 
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>calculette LAB</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
  body { 
    background-color: #F0F3FF; 
    color: #08104D; 
    font-family: Montserrat, sans-serif; 
    margin: 1rem; 
    font-size: 14px; 
  }
  
  h1, h4 { 
    color: #08104D; 
  }
  
  .entry { 
    border-left: 3px solid #08104D; 
    margin-left: 1rem; 
    padding-left: 1rem; 
    margin-bottom: 1rem; 
    position: relative; 
  }
  
  .input-group > * { 
    margin-right: 0.5rem; 
  }
  
  .input-group { 
    align-items: center; 
    display: flex; 
    flex-wrap: wrap; 
  }
  
  .input-group select, 
  .input-group input[type="text"], 
  .input-group input[type="number"] { 
    flex: 1 1 180px; 
    min-width: 120px; 
  }
  
  .input-group label { 
    white-space: nowrap; 
    margin-right: 0.25rem; 
  }
  
  .input-group .btn-sm { 
    flex: 0 0 auto; 
  }
  
  .sub-entries { 
    margin-top: 0.75rem; 
  }
  
  .btn-add-sub { 
    margin-bottom: 0.75rem; 
  }
  
  .checkbox-label { 
    margin-left: 0.25rem; 
  }
  
  .bg-alt-0 { 
    background-color: #f9f9f9; 
  }
  
  .bg-alt-1 { 
    background-color: #e6f7ff; 
  }
  
  .btn-validate { 
    background-color: orange; 
    color: white; 
    border: none; 
    padding: 8px 16px; 
    font-weight: bold; 
    border-radius: 6px; 
    cursor: pointer; 
    transition: background-color 0.3s ease; 
  }
  
  .btn-validate.validated { 
    background-color: #28a745; 
  }
  
  .text-danger { 
    color: #dc3545 !important; 
  }

  /* Animation de surbrillance pour les tooltips */
  @keyframes highlight { 
    0% { box-shadow: 0 0 10px 3px orange; } 
    50% { box-shadow: 0 0 10px 3px yellow; } 
    100% { box-shadow: 0 0 0 0 transparent; } 
  }
  
  .highlight-tooltip { 
    animation: highlight 10s ease-out forwards; 
  }

  /* Classe personnalisée pour tooltip rouge Bootstrap 5 */
  .tooltip-danger {
    --bs-tooltip-bg: #dc3545;
    --bs-tooltip-color: #fff;
  }
  
  .header-row {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
  }
  
  .header-row .col {
    font-weight: bold;
    text-align: center;
  }
</style>
</head>
<body>
<div class="container">
  <h1 class="mb-4 text-center">Calculette LAB</h1>

  <div class="card p-3 mb-4">
	  <div class="d-flex align-items-end justify-content-between">
	  
		<div class="flex-grow-1 me-3">
		  <label for="amount_paid" class="form-label">
			<strong>Montant PU versée (€)</strong>
		  </label>
		  <input type="number" id="amount_paid" class="form-control" min="0" step="0.01" value="0" required />
		</div>
		
		<div class="flex-grow-1 me-3">
		  <label for="last_name" class="form-label">
			<strong>Nom</strong>
		  </label>
		  <input type="text" id="last_name" class="form-control" value="" required />
		</div>
		<div class="flex-grow-1 me-3">
		  <label for="first_name" class="form-label">
			<strong>Prénom</strong>
		  </label>
		  <input type="text" id="first_name" class="form-control" value="" required />
		</div>
		

		<div>
		  <label class="form-label d-block"><strong>Compagnie</strong></label>
		  <div class="d-flex">
			<div class="form-check me-3">
			  <input class="form-check-input" type="radio" name="partner" id="partnerAbeille" value="Abeille" checked>
			  <label class="form-check-label" for="partnerAbeille">Abeille</label>
			</div>
			<div class="form-check">
			  <input class="form-check-input" type="radio" name="partner" id="partnerSwiss" value="SwissLife">
			  <label class="form-check-label" for="partnerSwiss">SwissLife</label>
			</div>
		  </div>
		</div>
	  </div>
  </div>

  <form id="form-origins" class="card p-3 mb-4">
    <h4>Origines des fonds</h4>
    <div class="row header-row py-2 mb-2">
      <div class="col">Support</div>
      <div class="col">Etablissement</div>
      <div class="col">N° de compte</div>
      <div class="col">Montant</div>
      <div class="col">Présents depuis le</div>
    </div> 
    <div id="origins-list"></div>
    <button type="submit" class="btn btn-success btn-validate">Valider</button>
	  <div class="mt-2 text-end">
		  <button type="button" class="btn btn-link btn-sm p-0 me-2" onclick="downloadData()" title="Sauvegarder">
			<i class="bi bi-cloud-download"></i>
		  </button>
		  <button type="button" class="btn btn-link btn-sm p-0" onclick="document.getElementById('fileInput').click()" title="Recharger">
			<i class="bi bi-cloud-upload"></i>
		  </button>
		  <input type="file" id="fileInput" style="display:none" onchange="uploadData(event)" />
	  </div>
  </form>


  <div id="results-term" class="card p-3" style="display:none;">
    <h4>Documents à fournir</h4>
 	<div id="results-docs"></div>
  </div>
</div>


<datalist id="bank-suggestions">
  <option value="Axa Banque - AXABFRPPXXX">
  <option value="Banque BCP - CCBPFRPPBCP">
  <option value="Banque Courtois - CCBPFRPPTLS">
  <option value="Banque Kolb - CCBPFRPPMTZ">
  <option value="Banque Laydernier - CCBPFRPPGRE">
  <option value="Banque Nuger - CCBPFRPPNUG">
  <option value="Banque Palatine - BSPFFRPPXXX">
  <option value="Banque Populaire - CCBPFRPPXXX">
  <option value="Barclays France - BARCFRPPXXX">
  <option value="BforBank - CEPAFRPP108">
  <option value="BNP Paribas - BNPAFRPPXXX">
  <option value="Boursorama Banque - BOUSFRPPXXX">
  <option value="Caisse d'Épargne - CEPAFRPPXXX">
  <option value="CIC - CMCIFRPPXXX">
  <option value="Crédit Agricole - AGRIFRPPXXX">
  <option value="Crédit Coopératif - CCOPFRPPXXX">
  <option value="Crédit du Nord - NORDFRPPXXX">
  <option value="Crédit Mutuel - CMCIFR2A (variable selon caisse)">
  <option value="Fortuneo - FORTFRPPXXX">
  <option value="Hello Bank! (BNP) - BNPAFRPPXXX">
  <option value="HSBC France - CCFRFRPPXXX">
  <option value="ING Direct - INGDFRPPXXX">
  <option value="La Banque Postale - PSSTFRPPXXX">
  <option value="LCL - Crédit Lyonnais - CRLYFRPPXXX">
  <option value="Monabanq - CCOPFRPPXXX">
  <option value="Orange Bank - ORNGFR21XXX">
  <option value="Revolut - REVOGB21XXX">
  <option value="Société Générale - SOGEFRPPXXX">
</datalist>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
'use strict';

// Variables globales
let indexDisplayNeededDocuments = 1;
let originGroupIndex = 1;

// Configuration - Textes paramétrables
const TEXTS = {
  // Labels et placeholders
  CHOOSE_SUPPORT: '-- Choisir support --',
  ESTABLISHMENT_PLACEHOLDER: 'Etablissement / Nom',
  ACCOUNT_PLACEHOLDER: 'Numéro de compte',
  AMOUNT_PLACEHOLDER: 'Montant',
  
  // Boutons
  BTN_ADD_SUB: '+ Origine précédente',
  BTN_REMOVE: '×',
  BTN_VALIDATE: 'Valider',
  BTN_MOVE_UP: 'Monter',
  BTN_MOVE_DOWN: 'Descendre',
  BTN_INDENT: 'Descendre d\'un niveau',
  BTN_OUTDENT: 'Remonter d\'un niveau',
  
  // Messages d'aide (tooltips)
  TOOLTIP_FIRST_LINE: 'Renseigner le compte courant payeur sur la première ligne',
  TOOLTIP_SUB_ORIGIN: 'Les fonds sont arrivés il y a moins de 6 mois, il faut détailler en indiquant l\'origine précédente',
  TOOLTIP_AMOUNT_MISMATCH: 'Somme des sous-origines: {amount} €',
  
  // Messages d'erreur
  ERROR_SELECT_SUPPORT: 'Veuillez sélectionner un support.',
  ERROR_ENTER_ESTABLISHMENT: 'Veuillez saisir un établissement.',
  ERROR_VALID_AMOUNT: 'Veuillez saisir un montant valide.',
  ERROR_ADD_SUB_ORIGIN: 'Veuillez ajouter au moins une sous-origine pour {name}.',
  ERROR_AMOUNT_MISMATCH: 'La somme des sous-origines ({subSum} €) ne correspond pas au montant de l\'origine "{name}" ({amount} €).',
  ERROR_PU_AMOUNT_INVALID: 'Veuillez saisir un Montant PU valide (≥ 0).',
  ERROR_TOTAL_MISMATCH: 'La somme des origines ({sum} €) ne correspond pas au Montant PU versé ({puAmount} €).',
  
  // Libellés pour l'affichage des résultats
  RESULT_SUPPORT: 'Support',
  RESULT_ESTABLISHMENT: 'Etablissement',
  RESULT_ACCOUNT: 'Compte',
  RESULT_AMOUNT: 'Montant',
  RESULT_DATE: 'Date d\'arrivée des fonds',
  RESULT_NOT_OLDER_THAN_THRESHOLD: 'Fonds arrivés il y a moins de 6 mois',
  NEEDED_DOCUMENTS: "Documents requis",
  LABEL_ACCOUNT_ROOT: 'Compte courant',
};

// Configuration - Paramètres
const CONFIG = {
  MONTHS_THRESHOLD: 6,
  TOOLTIP_DURATION_FIRST_LINE: 10000,
  TOOLTIP_DURATION_SUB_ORIGIN: 5000,
  AMOUNT_PRECISION: 0.01
};

// Données de référence devrait etre stockée ailleurs et rappatriée avec fetch()
const sourceOptions = [
    {
        "label": "Compte courant",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé du compte courant payeur de primes à + de 6 mois avec les fonds déjà présents et le relevé du compte courant payeur de primes à date de souscription avec solde suffisant"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé du compte courant payeur de primes à + de 6 mois avec les fonds déjà présents et le relevé du compte courant payeur de primes à date de souscription avec solde suffisant"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
	{
        "label": "Compte courant de Transit",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Le relevé du compte courant avec l'encaissement des fonds",
                    "Le relevé du compte courant avec le décaissement des fonds"
                ],
                "comments": [

                ]
            },
            "SwissLife": {
                "documents": [
                    "Le relevé du compte courant avec l'encaissement des fonds",
                    "Le relevé du compte courant avec le décaissement des fonds"
                ],
                "comments": [
                    
                ]
            }
        }
    },
    {
        "label": "Assurance-vie",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Attestation de rachat (et non demande)",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement du rachat stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Attestation de rachat (et non demande)",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement du rachat stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Livret A",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "LEP",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "CEL",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "PEL",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé du PEL à + de 6 mois",
                    "Attestation de clôture",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé du PEL à + de 6 mois",
                    "Attestation de clôture",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Livret jeune",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "LDDS",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "CSL",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé d’épargne à + de 6 mois",
                    "Relevé du livret d'épargne  avec décaissement stabiloté",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "CAT/DAT",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Documents d'ouverture",
                    "Document de clôture (seulement si retrait par anticipation)",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Documents d'ouverture",
                    "Document de clôture (seulement si retrait par anticipation)",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Epargne salariale",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Attestation de déblocage du paiement",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Attestation de déblocage du paiement",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "PEA/PEA-PME",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé d'épargne à + de 6 mois",
                    "Si les parts sont investies : avis d'opération de vente des titres/actions",
                    "Relevé du compte espèce avec décaissement",
                    "Relevé du compte courant payeur de prime avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé d'épargne à + de 6 mois",
                    "Si les parts sont investies : avis d'opération de vente des titres/actions",
                    "Relevé du compte espèce avec décaissement",
                    "Relevé du compte courant payeur de prime avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Compte-titres",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé d'épargne à + de 6 mois",
                    "Si les parts sont investies : avis d'opération de vente des titres/actions",
                    "Relevé du compte espèce avec décaissement",
                    "Relevé du compte courant payeur de prime avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé d'épargne à + de 6 mois",
                    "Si les parts sont investies : avis d'opération de vente des titres/actions",
                    "Relevé du compte espèce avec décaissement",
                    "Relevé du compte courant payeur de prime avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Donation/don manuel",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Acte notarié du don ou Cerfa de donation visé par l'administration fiscale",
                    "Si don manuel en ligne, joindre la déclaration et l'accusé de réception",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Nom du donateur et lien avec le souscripteur",
                    "Date de la donation",
                    "Montant de la donation",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Acte notarié du don ou Cerfa de donation visé par l'administration fiscale",
                    "Si don manuel en ligne, joindre la déclaration et l'accusé de réception",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Nom du donateur et lien avec le souscripteur",
                    "Date de la donation",
                    "Montant de la donation",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Bénéfice d'assurance-vie",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Attestation datée du bénéfice d'assurance-vie avec montant perçu et le/les bénéficiaires",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Attestation datée du bénéfice d'assurance-vie avec montant perçu et le/les bénéficiaires",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Vente de fonds de commerce",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Copie intégrale du protocole de cession ou attestation notariale ou d'avocat justifiant le montant de la cession",
                    "Relevé du compte courant payeur de prime avec encaissement stabiloté et solde suffisant à date de souscription"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Copie intégrale du protocole de cession ou attestation notariale ou d'avocat justifiant le montant de la cession",
                    "Relevé du compte courant payeur de prime avec encaissement stabiloté et solde suffisant à date de souscription"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Vente de parts sociales d'entreprise",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Copie intégrale du protocole de cession ou attestation notariale ou d'avocat justifiant le montant de la cession des parts sociales",
                    "Relevé du compte courant payeur de prime avec encaissement stabiloté et solde suffisant à date de souscription"
                ],
                "comments": [
                    "Si les fonds issus de la vente arrivent sur le compte courant professionnel, fournir le relevé du compte professionnel avec encaissement puis décaissement vers le compte courant payeur de prime",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Copie intégrale du protocole de cession ou attestation notariale ou d'avocat justifiant le montant de la cession des parts sociales",
                    "Relevé du compte courant payeur de prime avec encaissement stabiloté et solde suffisant à date de souscription"
                ],
                "comments": [
                    "Si les fonds issus de la vente arrivent sur le compte courant professionnel, fournir le relevé du compte professionnel avec encaissement puis décaissement vers le compte courant payeur de prime",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Prime exceptionnelle",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Copie du bulletin de salaire",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Date et montant des revenus",
                    "Nature des revenus exceptionnels (prime, bonus, intéressement, levée d'option, …)",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Copie du bulletin de salaire",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Date et montant des revenus",
                    "Nature des revenus exceptionnels (prime, bonus, intéressement, levée d'option, …)",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Indemnités assurance corporelle",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Document prouvant le montant exact perçu (tribunal, avocat, …)",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "FAIRE CONTRAT DE CAPITALISATION PERSONNE PHYSIQUE pour conserver les avantages fiscaux",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Document prouvant le montant exact perçu (tribunal, avocat, …)",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "FAIRE CONTRAT DE CAPITALISATION PERSONNE PHYSIQUE pour conserver les avantages fiscaux",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Indemnités autres dommages",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Document prouvant le montant exact perçu (tribunal, avocat, …)",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Document prouvant le montant exact perçu (tribunal, avocat, …)",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Cession de biens mobiliers",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Certificat ou acte de cession avec montant de la cession ou attestation notariale",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Date et objet de la vente",
                    "Montant de la vente",
                    "Identité du vendeur et de l'acquéreur",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Certificat ou acte de cession avec montant de la cession ou attestation notariale",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Date et objet de la vente",
                    "Montant de la vente",
                    "Identité du vendeur et de l'acquéreur",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Succession/héritage",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Acte notarié complet",
                    "Décompte notarié avec montant exact perçu",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Date du décès",
                    "Nom de la personne décédée",
                    "Nom des héritiers",
                    "Montant de l'héritage (comprenant le montant revenant au souscripteur)",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Acte notarié complet",
                    "Décompte notarié avec montant exact perçu",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Date du décès",
                    "Nom de la personne décédée",
                    "Nom des héritiers",
                    "Montant de l'héritage (comprenant le montant revenant au souscripteur)",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Vente immobilière ",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Acte de vente complet",
                    "Décompte notarié",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Date et objet de la vente",
                    "Montant de la vente (comprenant le montant revenant au souscripteur si plusieurs vendeurs)",
                    "Identité du vendeur et de l'acquéreur",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Acte de vente complet",
                    "Décompte notarié",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Date et objet de la vente",
                    "Montant de la vente (comprenant le montant revenant au souscripteur si plusieurs vendeurs)",
                    "Identité du vendeur et de l'acquéreur",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Vente immobilière SCI",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Acte de vente complet",
                    "Décompte notarié",
                    "Kbis + Statuts de la société",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Date et objet de la vente",
                    "Montant de la vente (comprenant le montant revenant au souscripteur si plusieurs vendeurs)",
                    "Identité du vendeur et de l'acquéreur",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Acte de vente complet",
                    "Décompte notarié",
                    "Kbis + Statuts de la société",
                    "Relevé du compte courant payeur de prime à date de souscription avec solde suffisant et encaissement stabiloté"
                ],
                "comments": [
                    "Date et objet de la vente",
                    "Montant de la vente (comprenant le montant revenant au souscripteur si plusieurs vendeurs)",
                    "Identité du vendeur et de l'acquéreur",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Distribution de dividendes",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "PV d'Assemblée Générale avec décision de versement de dividendes",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "PV d'Assemblée Générale avec décision de versement de dividendes",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Indemnités de licenciement",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Solde de tout compte",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Solde de tout compte",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Gains aux jeux",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Copie du justificatif de la Française des Jeux ou autres (PMU, casino, …)",
                    "OU copie du chèque de la Française des Jeux ou autres",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Nom de l'organisme de jeu",
                    "Date et montant du gain aux jeux",
                    "Identité du gagnant",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Copie du justificatif de la Française des Jeux ou autres (PMU, casino, …)",
                    "OU copie du chèque de la Française des Jeux ou autres",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription et encaissement stabiloté"
                ],
                "comments": [
                    "Nom de l'organisme de jeu",
                    "Date et montant du gain aux jeux",
                    "Identité du gagnant",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Remboursement de prêt familial",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Acte sous seing privé initial ou acte authentique notarial initial",
                    "Justificatifs de remboursement",
                    "Relevé avec encaissement des sommes restant dues sur le compte courant payeur de prime et solde suffisant à date de souscription",
                    "Tous documents visant le solde de l'emprunt",
                    "Cerfa 2062"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Acte sous seing privé initial ou acte authentique notarial initial",
                    "Justificatifs de remboursement",
                    "Relevé avec encaissement des sommes restant dues sur le compte courant payeur de prime et solde suffisant à date de souscription",
                    "Tous documents visant le solde de l'emprunt",
                    "Cerfa 2062"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Vente d'œuvre d'art",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Attestation de vente de l'objet d'art avec mentions légales obligatoires",
                    "Certificat d'authentification",
                    "Relevé avec encaissement du montant de la vente sur le compte courant payeur de prime avec solde suffisant à date de souscription",
                    "Formulaire 2091-SD ou 2092-SD visé par l'administration fiscale",
                    "Justificatifs d'entrée en possession si détenue depuis moins de 22 ans"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Attestation de vente de l'objet d'art avec mentions légales obligatoires",
                    "Certificat d'authentification",
                    "Relevé avec encaissement du montant de la vente sur le compte courant payeur de prime avec solde suffisant à date de souscription",
                    "Formulaire 2091-SD ou 2092-SD visé par l'administration fiscale",
                    "Justificatifs d'entrée en possession si détenue depuis moins de 22 ans"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Contrat ou bon de capitalisation",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Attestation de rachat (et non demande)",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement du rachat stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Attestation de rachat (et non demande)",
                    "Relevé du compte courant payeur de primes à date de souscription avec solde suffisant et encaissement du rachat stabiloté"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Vente de cryptoactifs",
        "needSource": 1,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé du portefeuille des cryptoactifs à 1 an",
                    "Relevé de vente des cryptoactifs à ce jour",
                    "Relevé du compte courant payeur de prime à date de souscription"
                ],
                "comments": [
                    "Date de vente",
                    "Prix de cession",
                    "Identité du vendeur",
                    "Lorsque les cryptoactifs ont été acquis il y a moins d'un an, l'origine antérieure doit être clairement précisée et justifiée",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé du portefeuille des cryptoactifs à 1 an",
                    "Relevé de vente des cryptoactifs à ce jour",
                    "Relevé du compte courant payeur de prime à date de souscription"
                ],
                "comments": [
                    "Date de vente",
                    "Prix de cession",
                    "Identité du vendeur",
                    "Lorsque les cryptoactifs ont été acquis il y a moins d'un an, l'origine antérieure doit être clairement précisée et justifiée",
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Vente de métaux précieux",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Attestation de vente de métaux précieux avec mentions légales obligatoires",
                    "Certificat d'authentification",
                    "Relevé avec encaissement du montant de la vente sur le compte courant payeur de prime avec solde suffisant à date de souscription",
                    "Formulaire 2091-SD ou 2092-SD visé par l'administration fiscale",
                    "Fustificatif d'entrée en possession si détenus depuis moins de 22 ans"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Attestation de vente de métaux précieux avec mentions légales obligatoires",
                    "Certificat d'authentification",
                    "Relevé avec encaissement du montant de la vente sur le compte courant payeur de prime avec solde suffisant à date de souscription",
                    "Formulaire 2091-SD ou 2092-SD visé par l'administration fiscale",
                    "Fustificatif d'entrée en possession si détenus depuis moins de 22 ans"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    },
    {
        "label": "Remboursement de compte courant d'associé",
        "needSource": 0,
        "partners": {
            "Abeille": {
                "documents": [
                    "Relevé du compte courant d'associé à + de 6 mois",
                    "Relevé du compte courant professionnel avec décaissement",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription + attestation de l'expert-comptable certifiant l'opération ou PV d'AG"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            },
            "SwissLife": {
                "documents": [
                    "Relevé du compte courant d'associé à + de 6 mois",
                    "Relevé du compte courant professionnel avec décaissement",
                    "Relevé du compte courant payeur de prime avec solde suffisant à date de souscription + attestation de l'expert-comptable certifiant l'opération ou PV d'AG"
                ],
                "comments": [
                    "Si opération en cours de mois, capture d'écran recevable si et seulement si on voit apparaître la date, le numéro de compte, le montant"
                ]
            }
        }
    }
]

// Éléments DOM
const originsList = document.getElementById('origins-list');
const formOrigins = document.getElementById('form-origins');
const resultsTerm = document.getElementById('results-term');
const resultsDocs = document.getElementById('results-docs');
const amountPaidInput = document.getElementById('amount_paid');
const validateBtn = formOrigins.querySelector('button[type="submit"]');

// Utilitaires
/**
 * Formate un montant en devise
 * @param {number} amount - Montant à formater
 * @returns {string} Montant formaté
 */
function formatCurrency(amount) {
  return amount.toLocaleString('fr-FR', { minimumFractionDigits: 2 });
}

/**
 * Parse de manière sécurisée un nombre décimal
 * @param {string|number} value - Valeur à parser
 * @param {number} fallback - Valeur par défaut
 * @returns {number} Valeur parsée ou fallback
 */
function safeParseFloat(value, fallback = 0) {
  const parsed = Number.parseFloat(value);
  return Number.isNaN(parsed) ? fallback : parsed;
}

/**
 * Remplace les placeholders dans un message
 * @param {string} message - Message avec placeholders
 * @param {Object} replacements - Objet clé-valeur des remplacements
 * @returns {string} Message formaté
 */
function formatMessage(message, replacements = {}) {
  return Object.entries(replacements).reduce((msg, [key, value]) => {
    return msg.replaceAll(`{${key}}`, value);
  }, message);
}

/**
 * Récupère une source par son label
 * @param {string} label - Label de la source
 * @returns {Object|undefined} Objet source
 */
function getSourceByLabel(label) {
  return sourceOptions.find(item => item.label === label);
}

/**
 * Nettoie et valide un nom/prénom
 * @param {string} input - Chaîne à nettoyer
 * @param {number} maxLen - Longueur maximale
 * @returns {string} Chaîne nettoyée
 */
function sanitizeName(input, maxLen = 100) {
  if (!input || typeof input !== 'string') return '';
  let s = input.trim().replaceAll(/\s+/g, ' ');
  s = s.replaceAll(/[^\p{L}\p{M}\s'-]/gu, '');
  if (s.length > maxLen) s = s.slice(0, maxLen);
  return s;
}

/**
 * Remplit les champs nom/prénom depuis les paramètres URL
 */
function populateNameSurnameFromQuery() {
  try {
    const params = new URLSearchParams(globalThis.location.search);
    const rawLast = params.get('last_name') || params.get('nom') || '';
    const rawFirst = params.get('first_name') || params.get('prenom') || '';

    const last = sanitizeName(decodeURIComponent(rawLast));
    const first = sanitizeName(decodeURIComponent(rawFirst));

    if (last) {
      const el = document.getElementById('last_name');
      if (el) el.value = last;
    }
    if (first) {
      const el = document.getElementById('first_name');
      if (el) el.value = first;
    }
  } catch (e) {
    console.warn('populateFromQuery error', e);
  }
}

/**
 * Vérifie si un support nécessite une origine
 * @param {string} supportLabel - Label du support
 * @returns {boolean} True si nécessite une origine
 */
function sourceNeedsOrigin(supportLabel) {
  const source = getSourceByLabel(supportLabel);
  return source ? source.needSource === 1 : true; 
}

/**
 * Affiche/masque les éléments selon le support sélectionné
 * @param {HTMLElement} entryDiv - Div de l'entrée
 * @param {string} supportValue - Valeur du support
 */
function toggleSourceElements(entryDiv, supportValue) {
  const btnAddSub = entryDiv.querySelector('.btn-add-sub');
  if (sourceNeedsOrigin(supportValue)) {
      btnAddSub.style.display = 'inline-block';
  } else {
    btnAddSub.style.display = 'none';
  }
}

/**
 * Exporte les données en JSON
 */
function downloadData() {
  const puAmount = safeParseFloat(amountPaidInput.value);
  const firstName = sanitizeName(document.getElementById('first_name').value);
  const lastName = sanitizeName(document.getElementById('last_name').value);
  
  const partner = getSelectedPartner();
  const validation = validateEntries(originsList);
  if (validation === null) return;

  const data = { puAmount, firstName, lastName, partner, entries: validation.results };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "calculetteLAB.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/**
 * Importe les données depuis un fichier JSON
 * @param {Event} event - Événement de changement de fichier
 */
function uploadData(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);

      amountPaidInput.value = data.puAmount;
      const partnerRadio = document.querySelector(`input[name="partner"][value="${data.partner}"]`);
      if (partnerRadio) partnerRadio.checked = true;
      document.getElementById('first_name').value = sanitizeName(data.firstName);
      document.getElementById('last_name').value = sanitizeName(data.lastName);

      originsList.innerHTML = "";
      createEntry(originsList, 1, true);
      resultsDocs.innerHTML = '';
      resultsTerm.style.display = 'none';
      setButtonValidated(false);
      
      // Restauration récursive
      function restoreEntries(results, parentDiv, level = 1) {
        results.forEach((r, idx) => {
          let entry;
          if (level === 1 && idx === 0) {
            entry = parentDiv.children[0];
          } else {
            entry = createEntry(parentDiv, level, false);
          }

          const select = entry.querySelector("select");
          const inputsText = entry.querySelectorAll('input[type="text"]');
          const inputName = inputsText[0];
          const inputAccount = inputsText[1];
          const inputAmount = entry.querySelector('input[type="number"]');
          const inputDate = entry.querySelector('input[type="date"]');
          
          select.value = r.support;
          inputName.value = r.name;
          inputAccount.value = r.accountNumber;
          inputAmount.value = r.amount;
          if (r.date) inputDate.value = r.date;
          
          toggleSourceElements(entry, r.support);
          
          if (r.subOrigins && r.subOrigins.length > 0) {
            const btnAddSub = entry.querySelector(".btn-add-sub");
            btnAddSub.style.display = "inline-block";
            const subDiv = entry.querySelector(".sub-entries");
            restoreEntries(r.subOrigins, subDiv, level + 1);
          }
        });
      }
      
      restoreEntries(data.entries, originsList);
      refreshOutdentButtons();
      refreshMoveButtons();
    } catch (error) {
      alert('Erreur lors du chargement du fichier : ' + error.message);
    }
  };
  
  reader.onerror = () => {
    alert('Erreur lors de la lecture du fichier');
  };
  
  reader.readAsText(file);
  document.getElementById('fileInput').value = '';
}

/**
 * Change l'apparence du bouton valider
 * @param {boolean} valid - État de validation
 */
function setButtonValidated(valid) {
  if (valid) {
    validateBtn.classList.add('validated');
    validateBtn.classList.remove('btn-warning');
  } else {
    validateBtn.classList.remove('validated');
    validateBtn.classList.add('btn-warning');
  }
}

/**
 * Marque le formulaire comme modifié
 */
function markModified() {
  setButtonValidated(false);
  resultsTerm.style.display = 'none';
}

/**
 * Met à jour le statut des montants parents
 * @param {HTMLElement} entry - Élément d'entrée
 */
function updateParentAmountStatus(entry) {
  const parentDiv = entry.closest('.entry');
  if (!parentDiv) return;
  
  const inputAmountParent = entry.querySelector('.input-group input[type="number"]');
  const subEntries = entry.querySelector(':scope > .sub-entries');
  if (!inputAmountParent || !subEntries) return;
  
  const directChildren = Array.from(subEntries.children);
  const subSum = directChildren.reduce((acc, child) => {
    const amt = child.querySelector('.input-group input[type="number"]');
    return acc + safeParseFloat(amt?.value);
  }, 0);
  
  const parentAmount = safeParseFloat(inputAmountParent.value);
  
  let tip = bootstrap.Tooltip.getInstance(inputAmountParent);
  if (tip) tip.dispose();
  
  //if (directChildren.length > 0 && Math.abs(subSum - parentAmount) > CONFIG.AMOUNT_PRECISION) {
  if (directChildren.length > 0 && Math.abs(subSum) < parentAmount) {
    inputAmountParent.classList.add('text-danger');
    const tooltipText = formatMessage(TEXTS.TOOLTIP_AMOUNT_MISMATCH, { amount: formatCurrency(subSum) });
    inputAmountParent.title = tooltipText;
    inputAmountParent.dataset.bsToggle = 'tooltip';
    inputAmountParent.dataset.bsPlacement = 'top';
    inputAmountParent.dataset.bsCustomClass = 'tooltip-danger';
    tip = new bootstrap.Tooltip(inputAmountParent);
    tip.show();
  } else {
    inputAmountParent.classList.remove('text-danger');
    inputAmountParent.title = '';
    delete inputAmountParent.dataset.bsToggle;
    delete inputAmountParent.dataset.bsPlacement;
    delete inputAmountParent.dataset.bsCustomClass;
  }
  
  const parentEntry = entry.parentElement ? entry.parentElement.closest('.entry') : null;
  if (parentEntry) updateParentAmountStatus(parentEntry);
}

/**
 * Crée une entrée dans le formulaire
 * @param {HTMLElement} parentDiv - Conteneur parent
 * @param {number} groupIndex - Niveau de profondeur
 * @param {boolean} isFirst - Si c'est la première ligne
 * @returns {HTMLElement} L'élément div créé
 */
function createEntry(parentDiv = originsList, groupIndex = 1, isFirst = false) {
  const entryDiv = createMainContainer(groupIndex);
  const group = document.createElement('div');
  group.className = 'input-group';
  
  const select       = createSupportSelect();
  const inputName    = createEstablishmentInput();
  const inputAccount = createAccountInput();
  const inputAmount  = createAmountInput();
  const dateDiv      = createDateContainer();
  const btnAddSub    = createAddSubButton();
  const btnRemove    = createRemoveButton();
  const btnMoveUp    = createActionButton('bi-arrow-up', TEXTS.BTN_MOVE_UP, 'move-up');
  const btnMoveDown  = createActionButton('bi-arrow-down', TEXTS.BTN_MOVE_DOWN, 'move-down');
  const btnIndent    = createActionButton('bi-arrow-return-right', TEXTS.BTN_INDENT, 'indent');
  const btnOutdent   = createActionButton('bi-arrow-return-left', TEXTS.BTN_OUTDENT, 'outdent');

  [select, inputName, inputAccount, inputAmount, dateDiv, btnAddSub, 
   btnMoveUp, btnMoveDown, btnIndent, btnOutdent, btnRemove].forEach(el => group.appendChild(el));

  const subEntriesDiv = createSubEntriesContainer();
  entryDiv.appendChild(group);
  entryDiv.appendChild(subEntriesDiv);
  parentDiv.appendChild(entryDiv);

  if (isFirst) {
    configureFirstLine(select, inputAmount, inputAccount, btnRemove, entryDiv, 
                       btnMoveUp, btnMoveDown, btnIndent, btnOutdent);
  }

  setupEventListeners({
    inputDate: dateDiv.querySelector('input'), btnAddSub, subEntriesDiv, btnRemove, inputAmount, entryDiv, 
    groupIndex, select, inputName, inputAccount, btnMoveUp, btnMoveDown, btnIndent, btnOutdent
  });
  
  return entryDiv;
}

function createMainContainer(groupIndex) {
  const entryDiv = document.createElement('div');
  entryDiv.className = `entry ${groupIndex === 1 ? 'bg-alt-1' : 'bg-alt-0'}`;
  return entryDiv;
}

function createSupportSelect() {
  const select = document.createElement('select');
  select.className = 'form-control';
  select.required = true;
  select.ariaLabel = 'Support financier';
  
  const placeholderOpt = document.createElement('option');
  placeholderOpt.value = '';
  placeholderOpt.textContent = TEXTS.CHOOSE_SUPPORT;
  placeholderOpt.disabled = true;
  placeholderOpt.selected = true;
  select.appendChild(placeholderOpt);
  
  sourceOptions.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt.label;
    option.textContent = opt.label;
    select.appendChild(option);
  });
  return select;
}

function createEstablishmentInput() {
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = TEXTS.ESTABLISHMENT_PLACEHOLDER;
  input.className = 'form-control input-establishment';
  //input.list = 'bank-suggestions';
  input.setAttribute('list', 'bank-suggestions');
  input.required = true;
  input.ariaLabel = TEXTS.ESTABLISHMENT_PLACEHOLDER;
  return input;
}

function createAccountInput() {
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = TEXTS.ACCOUNT_PLACEHOLDER;
  input.className = 'form-control input-account';
  input.required = false;
  input.ariaLabel = TEXTS.ACCOUNT_PLACEHOLDER;
  return input;
}

function createAmountInput() {
  const input = document.createElement('input');
  input.type = 'number';
  input.min = '0';
  input.step = '0.01';
  input.placeholder = TEXTS.AMOUNT_PLACEHOLDER;
  input.className = 'form-control';
  input.style.flex = '0 0 120px';
  input.style.maxWidth = '120px';
  input.required = true;
  input.ariaLabel = TEXTS.AMOUNT_PLACEHOLDER;
  return input;
}

function createDateContainer() {
  const dateDiv = document.createElement('div');
  dateDiv.className = 'd-flex align-items-center input-date';
  dateDiv.style.flex = '0 0 180px';
  
  const inputDate = document.createElement('input');
  inputDate.type = 'date';
  inputDate.className = 'form-control';
  inputDate.required = true;
  inputDate.ariaLabel = 'Date d\'arrivée des fonds';
  
  dateDiv.appendChild(inputDate);
  return dateDiv;
}

function createAddSubButton() {
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.textContent = TEXTS.BTN_ADD_SUB;
  btn.className = 'btn btn-secondary btn-sm btn-add-sub';
  btn.style.display = 'none';
  return btn;
}

function createRemoveButton() {
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.textContent = TEXTS.BTN_REMOVE;
  btn.className = 'btn btn-danger btn-sm';
  btn.ariaLabel = 'Supprimer cette ligne';
  return btn;
}

function createActionButton(icon, text, role) {
  const btn = document.createElement('button');
  btn.type = 'button';
  btn.innerHTML = '<i class="bi ' + icon + '" style="font-size:0.65rem"></i>';
  btn.className = 'btn btn-light btn-sm p-0 px-1 text-muted';
  btn.title = text;
  btn.ariaLabel = text;
  btn.dataset.role = role;
  return btn;
}

function refreshOutdentButtons() {
  const root = originsList.querySelector(':scope > .entry');
  if (!root) return;
  
  const allEntries = Array.from(originsList.querySelectorAll('.entry')).filter(e => e !== root);
  for (const entry of allEntries) {
    const outBtn = entry.querySelector(':scope > .input-group [data-role="outdent"]');
    if (outBtn) outBtn.style.display = '';
  }
  
  const directChildren = Array.from(root.querySelector(':scope > .sub-entries').children);
  for (const child of directChildren) {
    const outBtn = child.querySelector(':scope > .input-group [data-role="outdent"]');
    if (outBtn) outBtn.style.display = 'none';
  }
}

function refreshMoveButtons() {
  const levels = document.querySelectorAll('.sub-entries');
  levels.forEach(level => {
    const entries = Array.from(level.querySelectorAll(':scope > .entry'));
    entries.forEach((entry, index) => {
      const btnUp   = entry.querySelector('[data-role="move-up"]');
      const btnDown = entry.querySelector('[data-role="move-down"]');
      if (btnUp)   btnUp.style.display   = (index === 0) ? 'none' : '';
      if (btnDown) btnDown.style.display = (index === entries.length - 1) ? 'none' : '';
    });
  });
}

function createSubEntriesContainer() {
  const div = document.createElement('div');
  div.className = 'sub-entries';
  return div;
}

function configureFirstLine(
  select, inputAmount, inputAccount, btnRemove, entryDiv,
  btnMoveUp, btnMoveDown, btnIndent, btnOutdent) {
  
  select.value = TEXTS.LABEL_ACCOUNT_ROOT;
  select.disabled = true;
  inputAmount.value = safeParseFloat(amountPaidInput.value);
  inputAmount.disabled = true;
  inputAccount.required = false;
  btnRemove.style.display = 'none';
  
  [btnMoveUp, btnMoveDown, btnIndent, btnOutdent].forEach(btn => { 
    if (btn) btn.style.display = 'none'; 
  });
  
  select.title = TEXTS.TOOLTIP_FIRST_LINE;
  select.dataset.bsToggle = 'tooltip';
  select.dataset.bsPlacement = 'top';
  
  const firstTooltip = new bootstrap.Tooltip(select);
  firstTooltip.show();
  select.classList.add('highlight-tooltip');
  
  setTimeout(() => {
    firstTooltip.hide();
    select.classList.remove('highlight-tooltip');
  }, CONFIG.TOOLTIP_DURATION_FIRST_LINE);
  
  amountPaidInput.addEventListener('input', () => {
    inputAmount.value = safeParseFloat(amountPaidInput.value);
    markModified();
    updateParentAmountStatus(entryDiv);
  });
  
  refreshOutdentButtons();
  refreshMoveButtons();
}

function updateAddSubButton(select, inputDate, btnAddSub) {
  if (!btnAddSub) return;
  
  const supportEligible = sourceNeedsOrigin(select.value);
  const dateValue = inputDate.value ? new Date(inputDate.value) : null;
  const dateThreshold = new Date();
  dateThreshold.setMonth(dateThreshold.getMonth() - CONFIG.MONTHS_THRESHOLD);
  
  if (supportEligible && dateValue && dateValue > dateThreshold) {
    btnAddSub.style.display = 'inline-block';
    btnAddSub.title = TEXTS.TOOLTIP_SUB_ORIGIN;
    btnAddSub.dataset.bsToggle = 'tooltip';
    btnAddSub.dataset.bsPlacement = 'top';
    
    const subTooltip = new bootstrap.Tooltip(btnAddSub);
    subTooltip.show();
    setTimeout(() => subTooltip.hide(), CONFIG.TOOLTIP_DURATION_SUB_ORIGIN);
  } else {
    btnAddSub.style.display = 'none';
  }
}

function setupEventListeners(elements) {
  const {
    inputDate, btnAddSub, subEntriesDiv, btnRemove,
    inputAmount, entryDiv, groupIndex, select,
    inputName, inputAccount,
    btnMoveUp, btnMoveDown, btnIndent, btnOutdent
  } = elements;
  
  select.addEventListener('change', () => {
    toggleSourceElements(entryDiv, select.value);
    updateAddSubButton(select, inputDate, btnAddSub);
    markModified();
  });
  
  inputDate.addEventListener('change', () => {
    updateAddSubButton(select, inputDate, btnAddSub);
    markModified();
  });
  
  btnAddSub.addEventListener('click', () => {
    const subEntry = createEntry(subEntriesDiv, groupIndex + 1);
    const subAmount = subEntry.querySelector('.input-group input[type="number"]');
    subAmount.addEventListener('input', () => updateParentAmountStatus(entryDiv));
    updateParentAmountStatus(entryDiv);
    markModified();
    refreshOutdentButtons();
    refreshMoveButtons();
  });
  
  btnMoveUp.addEventListener('click', () => {
    const prev = entryDiv.previousElementSibling;
    if (prev) {
      entryDiv.parentElement.insertBefore(entryDiv, prev);
      markModified();
      refreshOutdentButtons();
      refreshMoveButtons();
    }
  });
  
  btnMoveDown.addEventListener('click', () => {
    const next = entryDiv.nextElementSibling;
    if (next) {
      entryDiv.parentElement.insertBefore(next, entryDiv);
      markModified();
      refreshOutdentButtons();
      refreshMoveButtons();
    }
  });
  
  btnIndent.addEventListener('click', () => {
    const prev = entryDiv.previousElementSibling;
    if (prev) {
      const prevSub = prev.querySelector(':scope > .sub-entries');
      if (prevSub) {
        const oldParent = entryDiv.parentElement.closest('.entry');
        prevSub.appendChild(entryDiv);
        if (oldParent) updateParentAmountStatus(oldParent);
        updateParentAmountStatus(prev);
        markModified();
        refreshOutdentButtons();
        refreshMoveButtons();
      }
    }
  });
  
  btnOutdent.addEventListener('click', () => {
    const parentEntry = entryDiv.parentElement.closest('.entry');
    if (parentEntry) {
      const grandParent = parentEntry.parentElement;
      grandParent.insertBefore(entryDiv, parentEntry.nextElementSibling);
      updateParentAmountStatus(parentEntry);
      const gpEntry = grandParent.closest('.entry');
      if (gpEntry) updateParentAmountStatus(gpEntry);
      markModified();
      refreshOutdentButtons();
      refreshMoveButtons();
    }
  });
  
  btnRemove.addEventListener('click', () => {
    const parentEntry = entryDiv.parentElement.closest('.entry');
    entryDiv.remove();
    if (parentEntry) updateParentAmountStatus(parentEntry);
    markModified();
    refreshOutdentButtons();
    refreshMoveButtons();
  });
  
  [select, inputName, inputAccount, inputDate].forEach(element => {
    element.addEventListener('input', markModified);
  });
  
  inputAmount.addEventListener('input', () => {
    updateParentAmountStatus(entryDiv);
    markModified();
  });
}

function getSelectedPartner() {
  const selected = document.querySelector('input[name="partner"]:checked');
  return selected ? selected.value : null;
}

function alertAndStop(message) {
  alert(message);
  return null;
}

function sortByDate(entries) {
  return entries.sort((a, b) => {
    if (!a.date) return 1;
    if (!b.date) return -1;
    return new Date(a.date) - new Date(b.date);
  });
}

function validateEntry(entry) {
  const select       = entry.querySelector('select');
  const inputsText   = entry.querySelectorAll('input[type="text"]');
  const inputName    = inputsText[0];
  const inputAccount = inputsText[1];
  const inputAmount  = entry.querySelector('input[type="number"]');
  const inputDate    = entry.querySelector('input[type="date"]');
  const subDiv       = entry.querySelector('.sub-entries');
  const supportLabel = select.value;
  const needsSource  = sourceNeedsOrigin(supportLabel);

  
  if (!supportLabel) return alertAndStop(TEXTS.ERROR_SELECT_SUPPORT);
  if (!inputName.value.trim()) return alertAndStop(TEXTS.ERROR_ENTER_ESTABLISHMENT);

  const amount = safeParseFloat(inputAmount.value);
  if (Number.isNaN(amount) || amount < 0) return alertAndStop(TEXTS.ERROR_VALID_AMOUNT);

  const dateValue = new Date(inputDate.value);
  const dateThreshold = new Date();
  dateThreshold.setMonth(dateThreshold.getMonth() - CONFIG.MONTHS_THRESHOLD);
  const isLessThanDateThreshold = dateValue > dateThreshold;
  let subResults = [];
  if (isLessThanDateThreshold && needsSource) {
    if (subDiv.children.length === 0) {
      return alertAndStop(formatMessage(TEXTS.ERROR_ADD_SUB_ORIGIN, { name: inputName.value }));
    }
    const subValidation = validateEntries(subDiv);
    if (!subValidation) return null;
    subResults = sortByDate(subValidation.results);
    const subSum = subValidation.sum;
    if (Math.abs(subSum) < amount) {
      return alertAndStop(formatMessage(TEXTS.ERROR_AMOUNT_MISMATCH, {
        subSum: subSum.toFixed(2),
        name: inputName.value,
        amount: amount.toFixed(2)
      }));
    }
  }
  
  return {
    support: supportLabel, 
    name: inputName.value.trim(),
    accountNumber: inputAccount.value.trim(), 
    amount,
    date: inputDate.value.trim(), 
    isLessThanDateThreshold, 
    subOrigins: subResults
  };
}

function validateEntries(parentDiv) {
  const entries = Array.from(parentDiv.children);
  let sum = 0;
  const results = [];
  
  for (const entry of entries) {
    const validated = validateEntry(entry);
    if (!validated) return null;
    sum += validated.amount;
    results.push(validated);
  }
  
  return { sum, results };
}

function displayResults(results, container) {
  const ul = document.createElement('ul');
  results.forEach(r => {
    const li = document.createElement('li');
    
    const parts = [
      `<strong>${TEXTS.RESULT_SUPPORT}:</strong> ${r.support}`,
      `<strong>${TEXTS.RESULT_ESTABLISHMENT}:</strong> ${r.name}`,
      `<strong>${TEXTS.RESULT_ACCOUNT}:</strong> ${r.accountNumber}`,
      `<strong>${TEXTS.RESULT_AMOUNT}:</strong> ${formatCurrency(r.amount)} €`
    ];
    
    if (r.date) {
      parts.push(`<strong>${TEXTS.RESULT_DATE}:</strong> ${r.date}`);
    }
    
    if (r.isLessThanDateThreshold) {
      parts.push(`<strong>${TEXTS.RESULT_NOT_OLDER_THAN_THRESHOLD}</strong>`);
    }
    
    li.innerHTML = parts.join(', ');
    
    if (r.subOrigins.length > 0) {
      li.appendChild(displayResults(r.subOrigins, li));
    }
    ul.appendChild(li);
  });
  container.appendChild(ul);
  return ul;
}

function displayNeededDocuments(results, partner, tbody, level) {
  results.forEach(r => {
    const source = getSourceByLabel(r.support);
    if (!source) return;
    
    if (r.isLessThanDateThreshold && level === 1) {
      // On ne traite pas le compte courant s'il a une sous origine
    } else {
      const row = document.createElement("tr");
      
      const cell0 = document.createElement("td");
      const p0 = document.createElement('p');
      p0.textContent = indexDisplayNeededDocuments++;
      cell0.appendChild(p0);
      
      const cell1 = document.createElement("td");
      const infoParts = [r.support, r.name, r.accountNumber, `${formatCurrency(r.amount)} €`];
      cell1.innerHTML = infoParts.join("<strong> / </strong>");
      
      const cell2 = document.createElement("td");
      const tableDoc = document.createElement("table");
      tableDoc.className = "table table-bordered";
      
      source.partners[partner].documents.forEach(doc => {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        const pDoc = document.createElement('p');
        pDoc.textContent = doc;
        td.appendChild(pDoc);
        tr.appendChild(td);
        tableDoc.appendChild(tr);
      });
      cell2.appendChild(tableDoc);
      
      const cell3 = document.createElement("td");
      source.partners[partner].comments.forEach(comment => {
        const pComment = document.createElement("p");
        pComment.textContent = comment;
        cell3.appendChild(pComment);
      });
      
      [cell0, cell1, cell2, cell3].forEach(c => row.appendChild(c));
      tbody.appendChild(row);
    }
    
    if (r.subOrigins.length > 0) {
      displayNeededDocuments(r.subOrigins, partner, tbody, level + 1);
    }
  });
  
  return tbody;
}

formOrigins.addEventListener('submit', e => {
  e.preventDefault();
  
  const puAmount = safeParseFloat(amountPaidInput.value); 
  if (Number.isNaN(puAmount) || puAmount < 0) {
    alert(TEXTS.ERROR_PU_AMOUNT_INVALID);
    return;
  }
  
  const validation = validateEntries(originsList);
  if (validation === null) return;
  
  if (Math.abs(validation.sum - puAmount) > CONFIG.AMOUNT_PRECISION) {
    alert(formatMessage(TEXTS.ERROR_TOTAL_MISMATCH, {
      sum: validation.sum.toFixed(2),
      puAmount: puAmount.toFixed(2)
    }));
    return;
  }
  
  const table = document.createElement('table');
  table.className = 'table table-bordered table-striped';
  const thead = document.createElement('thead');
  thead.innerHTML = "<tr><th>No</th><th>Support</th><th>Documents requis</th><th>Informations</th></tr>";
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  table.appendChild(tbody);
  
  indexDisplayNeededDocuments = 1;
  displayNeededDocuments(validation.results, getSelectedPartner(), tbody, 1);
  
  resultsDocs.innerHTML = '';
  resultsDocs.appendChild(table);
  resultsTerm.style.display = 'block';
  setButtonValidated(true);
});

// Initialisation
populateNameSurnameFromQuery();

document.querySelectorAll('input[name="partner"]').forEach(radio => {
  radio.addEventListener('change', () => {
    markModified();
  });
});

validateBtn.classList.add('btn-warning');
amountPaidInput.addEventListener('input', markModified);
originsList.addEventListener('input', markModified);
createEntry(originsList, originGroupIndex, true);
</script>
</body>
</html>